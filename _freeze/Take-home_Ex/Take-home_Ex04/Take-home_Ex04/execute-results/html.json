{
  "hash": "d6b04ff9817ba705cdf66efe9f8d94eb",
  "result": {
    "markdown": "---\ntitle: \"Climate and Dengue in Singapore\"\nauthor: \"Colin Jiang Kelin\"\ndate: \"February 27, 2024\"\ndate-modified: \"last-modified\"\nexecute: \n  eval: true\n  echo: true\n  freeze: true\n  message: false\n  warning: false\neditor: visual\n---\n\n\n# 1. Overview\n\nshort intro here\n\n# 2. Getting Started\n\n## 2.1 Loading libraries\n\nIn this exercise, we will be requiring the following libraries.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(\n  ggplot2,\n  ggthemes,\n  tidyverse,\n  data.table,\n  zoo,\n  ggfortify,\n  reshape,\n  MLmetrics\n)\n```\n:::\n\n\n## 2.2 Data import\n\nFor this exercise, we will be using the climate data sets from the [Meteorological Service Singapore](http://www.weather.gov.sg/home/) and the dengue data set from the [SGCharts: Outbreak](https://outbreak.sgcharts.com/data) website.\n\n### 2.2.1 Climate data\n\nHistorical daily climate records can be downloaded directly from [this page](http://www.weather.gov.sg/climate-historical-daily/) in the [Meteorological Service Singapore](http://www.weather.gov.sg/home/) web page.\n\nHowever, there are several things to note about this data set:\n\n1.  There are a total of 63 weather stations in Singapore, out of which, only 18 of them keeps records of rainfall, temperature, and wind speed. The other 41 only has rainfall records. [**As such, we will only look at the 18 stations with all records for consistency.**]{.underline}\n\n2.  The oldest data dates back to 1980, but only in a few stations. In fact, from 2009, manual observations were gradually replaced by automated meteorological instruments. [**Therefore, we will try to keep our analysis limited to data from 2009 where possible.**]{.underline}\n\nOn the more technical side of things, the data can only be downloaded for 1 weather station for 1 month at a time. If we were to download the data for the last 20 years manually, it would take 20years \\* 12months \\* 22stations = 5,280 iterations of downloads by hand. To tackle this task efficiently, a script is written to download the data automatically from the url provided.\n\nThis can be done simply by using the `data.table::fread` function with the url. For example, the code chunk below shows 1 iteration of download for Changi weather station for the month of January in 2024.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata.table::fread(\"http://www.weather.gov.sg/files/dailydata/DAILYDATA_S24_202401.csv\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n    Station Year Month Day Daily Rainfall Total (mm)\n 1:  Changi 2024     1   1                      49.6\n 2:  Changi 2024     1   2                       0.4\n 3:  Changi 2024     1   3                       8.8\n 4:  Changi 2024     1   4                      80.6\n 5:  Changi 2024     1   5                       4.2\n 6:  Changi 2024     1   6                       0.6\n 7:  Changi 2024     1   7                      64.0\n 8:  Changi 2024     1   8                       0.0\n 9:  Changi 2024     1   9                       2.6\n10:  Changi 2024     1  10                      63.2\n11:  Changi 2024     1  11                       0.0\n12:  Changi 2024     1  12                      12.4\n13:  Changi 2024     1  13                       0.0\n14:  Changi 2024     1  14                       0.0\n15:  Changi 2024     1  15                       0.4\n16:  Changi 2024     1  16                      20.6\n17:  Changi 2024     1  17                       5.6\n18:  Changi 2024     1  18                       0.4\n19:  Changi 2024     1  19                      17.0\n20:  Changi 2024     1  20                      23.4\n21:  Changi 2024     1  21                      13.4\n22:  Changi 2024     1  22                       0.0\n23:  Changi 2024     1  23                      43.4\n24:  Changi 2024     1  24                      34.0\n25:  Changi 2024     1  25                      54.6\n26:  Changi 2024     1  26                       0.0\n27:  Changi 2024     1  27                       0.0\n28:  Changi 2024     1  28                       0.4\n29:  Changi 2024     1  29                       0.0\n30:  Changi 2024     1  30                       0.0\n31:  Changi 2024     1  31                       0.0\n    Station Year Month Day Daily Rainfall Total (mm)\n    Highest 30 min Rainfall (mm) Highest 60 min Rainfall (mm)\n 1:                         24.6                         32.4\n 2:                          0.4                          0.4\n 3:                          8.2                          8.8\n 4:                         17.6                         22.4\n 5:                          3.0                          3.0\n 6:                          0.6                          0.6\n 7:                         12.8                         16.4\n 8:                          0.0                          0.0\n 9:                          0.8                          1.0\n10:                         19.0                         29.6\n11:                          0.0                          0.0\n12:                          5.6                          6.0\n13:                          0.0                          0.0\n14:                          0.0                          0.0\n15:                          0.2                          0.2\n16:                         11.6                         14.8\n17:                          4.2                          4.4\n18:                          0.2                          0.2\n19:                          5.2                          7.0\n20:                          4.6                          6.6\n21:                         10.6                         12.8\n22:                          0.0                          0.0\n23:                         35.6                         43.0\n24:                         13.8                         19.4\n25:                         29.4                         42.0\n26:                          0.0                          0.0\n27:                          0.0                          0.0\n28:                          0.2                          0.4\n29:                          0.0                          0.0\n30:                          0.0                          0.0\n31:                          0.0                          0.0\n    Highest 30 min Rainfall (mm) Highest 60 min Rainfall (mm)\n    Highest 120 min Rainfall (mm) Mean Temperature (°C)\n 1:                          37.2                  25.6\n 2:                           0.4                  27.3\n 3:                           8.8                  27.1\n 4:                          31.6                  24.8\n 5:                           3.4                  26.6\n 6:                           0.6                  27.6\n 7:                          26.0                  24.5\n 8:                           0.0                  26.7\n 9:                           1.0                  26.7\n10:                          45.8                  26.3\n11:                           0.0                  27.4\n12:                           6.4                  25.3\n13:                           0.0                  27.0\n14:                           0.0                  27.6\n15:                           0.2                  27.8\n16:                          17.8                  26.6\n17:                           4.6                  27.4\n18:                           0.2                  27.0\n19:                          10.8                  26.3\n20:                           8.6                  24.5\n21:                          13.4                  26.9\n22:                           0.0                  27.6\n23:                          43.4                  27.0\n24:                          24.8                  26.7\n25:                          48.6                  25.7\n26:                           0.0                  28.0\n27:                           0.0                  28.2\n28:                           0.4                  27.8\n29:                           0.0                  28.0\n30:                           0.0                  27.8\n31:                           0.0                  27.7\n    Highest 120 min Rainfall (mm) Mean Temperature (°C)\n    Maximum Temperature (°C) Minimum Temperature (°C) Mean Wind Speed (km/h)\n 1:                     28.8                     24.2                    9.6\n 2:                     32.0                     24.7                   12.1\n 3:                     31.5                     24.5                   10.0\n 4:                     26.3                     23.4                   10.8\n 5:                     29.7                     24.4                   14.4\n 6:                     31.2                     25.4                   10.7\n 7:                     26.9                     23.2                    8.3\n 8:                     31.4                     23.4                    9.6\n 9:                     30.4                     24.6                   10.6\n10:                     29.3                     24.3                    9.4\n11:                     30.0                     25.4                   13.2\n12:                     26.9                     23.4                   10.9\n13:                     31.0                     24.4                    8.3\n14:                     31.1                     25.7                   12.1\n15:                     31.3                     25.5                   15.1\n16:                     30.4                     23.9                   11.6\n17:                     31.2                     24.8                   18.5\n18:                     29.9                     25.5                   12.2\n19:                     30.7                     23.7                    9.3\n20:                     26.1                     23.3                    9.0\n21:                     32.3                     23.4                   10.5\n22:                     31.5                     24.8                   11.1\n23:                     32.9                     23.8                    9.9\n24:                     30.4                     23.9                   11.9\n25:                     30.2                     23.8                   11.0\n26:                     31.6                     25.4                   20.3\n27:                     31.2                     26.7                   20.4\n28:                     31.4                     25.4                   18.1\n29:                     31.2                     26.2                   19.6\n30:                     31.6                     25.6                   15.6\n31:                     32.0                     25.5                   16.1\n    Maximum Temperature (°C) Minimum Temperature (°C) Mean Wind Speed (km/h)\n    Max Wind Speed (km/h)\n 1:                  35.2\n 2:                  40.7\n 3:                  35.2\n 4:                  31.5\n 5:                  46.3\n 6:                  31.5\n 7:                  33.3\n 8:                  31.5\n 9:                  35.2\n10:                  53.7\n11:                  37.0\n12:                  42.6\n13:                  38.9\n14:                  35.2\n15:                  46.3\n16:                  38.9\n17:                  57.4\n18:                  50.0\n19:                  42.6\n20:                  31.5\n21:                  35.2\n22:                  29.6\n23:                  57.4\n24:                  37.0\n25:                  37.0\n26:                  48.2\n27:                  44.4\n28:                  46.3\n29:                  46.3\n30:                  37.0\n31:                  40.7\n    Max Wind Speed (km/h)\n```\n:::\n:::\n\n\nNow, we want to write a for loop to iterate over all 18 stations. Each station is identified by a unique key value represented in the following list.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstations = c(\n  \"paya lebar\" = \"06\",\n  \"tengah\" = \"23\",\n  \"changi\" = \"24\",\n  \"seletar\" = \"25\",\n  \"tai seng\" = \"43\",\n  \"jurong west\" = \"44\",\n  \"ang mo kio\" = \"109\",\n  \"clementi\" = \"50\",\n  \"admiralty\" = \"104\",\n  \"sentosa\" = \"60\",\n  \"pulau ubin\" = \"106\",\n  \"east coast parkway\" = \"107\",\n  \"marina barrage\" = \"108\",\n  \"newton\" = \"111\",\n  \"tuas south\" = \"115\",\n  \"pasir panjang\" = \"116\",\n  \"jurong island\" = \"117\",\n  \"choa chu kang south\" = \"121\"\n)\n```\n:::\n\n\nWe also want to iterate over the years and month number in the url. For now, we will download the last 20 years of data.\n\nAnother issue that we encountered was that some of the column names changed at certain years either due to a different spelling or symbol. There is also many white spaces in the name, which could make coding more tedious later on. As such, I opted to change all the column names to simpler short forms with underscore as the separator instead of space.\n\nThe code chunk below shows the list of old to new column names. A function is also written for the renaming task, to rename the columns as we download the data sets 1 by 1. This helps with the `data.table::rbindlist` used in the loop as all the column names needs to be the same as the data set before.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncol_names = c(\n  \"Station\" = \"Station\",\n  \"Year\" = \"Year\",\n  \"Month\" = \"Month\",\n  \"Daily Rainfall Total (mm)\" = \"daily_rainfall\",\n  \"Highest 30 Min Rainfall (mm)\" = \"highest_30m_rainfall\",\n  \"Highest 30 min Rainfall (mm)\" = \"highest_30m_rainfall\",\n  \"Highest 60 Min Rainfall (mm)\" = \"highest_60m_rainfall\",\n  \"Highest 60 min Rainfall (mm)\" = \"highest_60m_rainfall\",\n  \"Highest 120 Min Rainfall (mm)\" = \"highest_120m_rainfall\",\n  \"Highest 120 min Rainfall (mm)\" = \"highest_120m_rainfall\",\n  \"Mean Temperature (°C)\" = \"mean_temp\",\n  \"Mean Temperature (°C)\" = \"mean_temp\",\n  \"Mean Temperature (Â°C)\" = \"mean_temp\",\n  \"Maximum Temperature (°C)\" = \"max_temp\",\n  \"Maximum Temperature (°C)\" = \"max_temp\",\n  \"Maximum Temperature (Â°C)\" = \"max_temp\",\n  \"Minimum Temperature (°C)\" = \"min_temp\",\n  \"Minimum Temperature (°C)\" = \"min_temp\",\n  \"Minimum Temperature (Â°C)\" = \"min_temp\",\n  \"Mean Wind Speed (km/h)\" = \"mean_wind\",\n  \"Max Wind Speed (km/h)\" = \"max_wind\"\n)\n\nclean_names <- function(df, col_names) {\n\n  for (n in names(col_names)) {\n    names(df)[names(df) == n] <- col_names[[n]]\n  }\n  \n  return (df)\n}\n```\n:::\n\n\nFinally, we can write our loop. The full code is shown below.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show code\"}\npad_zero <- function(num) {\n  if (num < 10) {\n    return (paste0(\"0\", as.character(num)))\n  } else {\n    return (as.character(num))\n  }\n}\n\ndf <- data.table()\n\nfor (station in stations) {\n  for (y in 3:23) {\n    for (m in 1:12) {\n      year <- pad_zero(y)\n      month <- pad_zero(m)\n      tryCatch(\n        {\n          joining_df <- data.table::fread(paste0(\n          \"http://www.weather.gov.sg/files/dailydata/DAILYDATA_S\",\n          station,\n          \"_20\",\n          year,\n          month,\n          \".csv\"),\n          encoding = \"Latin-1\")\n          \n          joining_df <- clean_names(joining_df, col_names)\n          \n          df <- rbindlist(list(df, joining_df), use.names=TRUE, fill=TRUE)\n        }, error = function(e) {\n          print(e)\n        }\n      )\n    }\n  }\n}\n```\n:::\n\n\nAfter downloading, we save the data in a csv file with the `data.table::fwrite` function.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfwrite(df, \"data/clean_climate_data.csv\")\n```\n:::\n\n\n### 2.2.2 Weather Station data\n\nThe coordinates of each weather station can be found [here](http://www.weather.gov.sg/wp-content/uploads/2022/06/Station_Records.pdf). Due to the small number, I have manually collated them in a csv file and saved it.\n\n### 2.2.3 Load data\n\nAssuming we had already saved off the data previously, we will now load the data sets using the `readr::read_csv` function\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclimate <- data.table::fread(\"data/clean_climate_data.csv\", encoding=\"Latin-1\") %>% as.data.frame()\n```\n:::\n\n\n# 3. Preliminary EDA\n\nIn this section, we will perform some preliminary exploratory analysis to understand how our data looks like as a time series. This will help us determine whether each variable can or can not be used, or what additional wrangling that is required to be done before the time series analysis is possible.\n\nBut first, we have to do some additional cleaning as well to prevent errors.\n\n## 3.1 Remove unwanted characters\n\nThere are many observations with \"-\". To avoid errors, we will change all of them to 0s.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclimate <- data.frame(lapply(climate, function(x) gsub(\"—\", 0, x)), stringsAsFactors=F)\n```\n:::\n\n\n## 3.2 Data type\n\nNext, we want to ensure that all columns are in their correct data type. For Station, Year, Month, and Day, we want them to be factors. The rest should be numerical.\n\nFor those values that were coerced as NA, we will convert them to 0 as well.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclimate[c(\"Station\", \"Year\", \"Month\", \"Day\")] <- lapply(climate[c(\"Station\", \"Year\", \"Month\", \"Day\")] , factor)\n\nclimate[!names(climate) %in% c(\"Station\", \"Year\", \"Month\", \"Day\")] <- lapply(climate[!names(climate) %in% c(\"Station\", \"Year\", \"Month\", \"Day\")] , as.numeric)\n\nclimate[is.na(climate)] <- 0\n```\n:::\n\n\n## 3.3 Date column\n\nWe also want a date column for easier sorting in chronological order. To do that, we can use the `zoo::as.Date` function.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclimate$date <- as.Date(with(climate, paste(Year, Month, Day,sep=\"-\")), \"%Y-%m-%d\")\n\nclimate <- climate[order(climate$date), ]\n```\n:::\n\n\n## 3.4 Daily Mean Temperature, Rainfall, and Wind\n\nLet us explore how the mean temperature, rainfall, and wind looks like in the past 20 years.\n\nThe code chunk below plots the daily mean temperature over the last 20 years for each weather station. Similar code was used to plot the chart for rainfall and temperature as well.\n\n::: panel-tabset\n### Temperature\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show code\"}\nggplot() + \n  geom_line(data = climate, aes(x=date, y=mean_temp, colour=Station)) + \n  facet_wrap(~Station) + \n  ggtitle(\"Daily Mean Temperature in last 20 years\")\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex04_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n### Rainfall\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show code\"}\nggplot() + \n  geom_line(data = climate, aes(x=date, y=daily_rainfall, colour=Station)) + \n  facet_wrap(~Station) +\n  ggtitle(\"Daily rainfall in the last 20 years\")\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex04_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n### Wind\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show code\"}\nggplot() + \n  geom_line(data = climate, aes(x=date, y=mean_wind, colour=Station)) + \n  facet_wrap(~Station) +\n  ggtitle(\"Daily mean wind speed in the last 20 years\")\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex04_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n:::\n\n::: callout-note\n### Insights\n\n1.  The start date of each weather station varies. This should be taken into account when fitting the model, as well as in the date range selection in the Shiny App.\n2.  There are many periods within the time series where the data is missing, especially so in temperature and wind. **To deal with this, we can** **take the mean value of that month from other years as a filler value**. For example, if jan 2010 is missing, we can use the mean value from jan 2003-2009, and 2011-2023 to fill the gap.\n3.  Daily rainfall has many 0 values, representing days without rain. This however, makes it difficult to model a time series. **Thus, dates will be rolled up to monthly levels and we will analyse mean monthly values instead.** To be consistent, we will use monthly levels for temperature and wind data as well.\n:::\n\n::: callout-warning\n## Non-Captured v.s Missing data\n\n-   Non-captured data refers to the missing data before the date when the weather station started collecting that data. We do not want to modify non-captured data.\n\n-   Missing data refers to the data after the start date that is captured but missing for whatever reasons. We want to fill these gaps with appropriate estimation techniques.\n:::\n\n# 4. Data Wrangling\n\n## 4.1 Roll up to Monthly levels\n\nAs there are many instances of 0s within each month, we will have to ignore them as they will pull down the monthly average temperature or wind. Therefore, a function is written to calculate the non-zero mean value instead. However, this is not needed for rainfall as 0s would mean days with no rain.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Function to find non-zero mean from a dateframe column\nnon_zero_mean <- function(x) {\n  y <- mean(x[x!=0])\n  return (y)\n}\n```\n:::\n\n\nNext, we use the `dplyr::group_by` and `dplyr::summarise` functions to calculate the monthly average for all variables. We also re-create the date column as a function of year and month using `zoo::as.yearmon`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Apply non-zero means to monthly temp and wind variables\n# Apply mean to monthly rain variables\nmonthly_climate <- climate %>% \n  group_by(Station, Year, Month) %>% \n  summarise(mean_temp = non_zero_mean(mean_temp),\n            max_temp = non_zero_mean(max_temp),\n            min_temp = non_zero_mean(min_temp),\n            mean_wind = non_zero_mean(mean_wind),\n            max_wind = non_zero_mean(max_wind),\n            mean_rain = mean(daily_rainfall),\n            mean_30m_rain = mean(highest_30m_rainfall),\n            mean_60m_rain = mean(highest_60m_rainfall),\n            mean_120m_rain = mean(highest_120m_rainfall),\n            date = min(date))\n\n# Format date column as yearmon format\nmonthly_climate$date <- as.yearmon(monthly_climate$date)\n\n# Change any NAs to 0\nmonthly_climate[is.na(monthly_climate)] <- 0\n```\n:::\n\n\n## 4.2 Filling missing data with non-zero means\n\nThis task requires several steps which is performed by the code chunk below.\n\n1.  Iterate through all relevant temperature and wind variables.\n\n2.  For each variable, iterate through all the stations.\n\n3.  For each station, find the months where all data is missing.\n\n4.  Lastly, for each of these months, we replace the NA or 0 with the non-zero mean of the same month in other years for that station. For example, if Changi station jan 2010 is missing, then we will replace the value with the non-zero mean from Changi station jan 2003-2009, and 2011-2023.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show code\"}\n# Function to replace missing data with non-zero mean\nreplace_zero <- function(df, s, y, m, col) {\n  df[df$Station == s &\n       df$Year == y &\n       df$Month == m, col][[1]] <- non_zero_mean(df[df$Station == s & df$Month == m, col])\n  \n  return (df)\n}\n\n# Define temp and wind variables in list\ncolumns = c(\"mean_temp\", \"max_temp\", \"min_temp\", \"mean_wind\", \"max_wind\")\n\n# Create results data frame as a copy of monthly_climate\n# We will fill in the new non-zero values \nfilled_monthly_climate <- monthly_climate\n\n\n# Loop to find missing data\nfor (c in columns) {\n  for (s in levels(monthly_climate$Station)) {\n    \n    # Isolate data for station and climate variable\n    temp <- monthly_climate[monthly_climate$Station == s, \n                            c(\"Station\", \"Year\", \"Month\", \"date\", c)]\n    \n    # Sort by date\n    temp <- temp[order(temp$date), ]\n    \n    # Get cumulative sum to find start date\n    temp$cum_sum <- cumsum(temp[c])\n    \n    # Loop years and months to find missing months\n    for (y in levels(temp$Year)) {\n      for (m in levels(temp$Month)) {\n        \n        # Extract value and cumulative sum\n        value <- temp[temp$Year == y &\n                      temp$Month == m, c][[1]]\n        \n        cum_sum <- temp[temp$Year == y &\n                      temp$Month == m, \"cum_sum\"][[1]]\n        \n        # If value is numeric(0), next\n        # This usually occurs for rows with non-captured data\n        if (length(value) == 0) next\n        \n        # If value == 0 and is after start date (cumulative sum > 0)\n        # Replace zero with non-zero means\n        if (value == 0 & cum_sum > 0) {\n          temp <- replace_zero(temp, s, y, m, c)\n        }\n        \n        # If value is before start date, replace 0 with NA\n        # This will prevent ggplot from plotting a 0 value for \n        # data points before the start date\n        if (cum_sum == 0) {\n          temp[\n            temp$Year == y &\n              temp$Month == m,\n            c\n          ] <- NaN\n        }\n        \n        # Extract filled value from temp\n        new_value <- temp[temp$Year == y &\n                      temp$Month == m, c][[1]]\n        \n        # Assign to results data frame\n        filled_monthly_climate[\n          filled_monthly_climate$Station == s &\n            filled_monthly_climate$Year == y &\n            filled_monthly_climate$Month == m,\n          c\n        ] <- new_value\n      }\n    }\n  }\n}\n```\n:::\n\n\n## 4.3 Final look at data\n\nLet us chart the same variables once more and check if all values are fine now.\n\n::: panel-tabset\n### Temperature\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show code\"}\nggplot() + \n  geom_line(data = filled_monthly_climate, aes(x=date, y=mean_temp, colour=Station)) + \n  facet_wrap(~Station) + \n  ggtitle(\"Monthly Mean Temperature in last 20 years\")\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex04_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\n### Rainfall\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show code\"}\nggplot() + \n  geom_line(data = filled_monthly_climate, aes(x=date, y=mean_rain, colour=Station)) + \n  facet_wrap(~Station) +\n  ggtitle(\"Monthly rainfall in the last 20 years\")\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex04_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n### Wind\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show code\"}\nggplot() + \n  geom_line(data = filled_monthly_climate, aes(x=date, y=mean_wind, colour=Station)) + \n  facet_wrap(~Station) +\n  ggtitle(\"Monthly mean wind speed in the last 20 years\")\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex04_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n:::\n\n# 5. Time Series Forecasting\n\nIn this section, we will be using time series econometric models to forecast future climate conditions in Singapore.\n\n## 5.1 Input variables\n\nThis section determines the variable selection done by the user of the Shiny Application. It is split into 2 phases.\n\nPhase 1\n\n1.  User selects weather station and climate variable using drop-down list.\n\n2.  The code will filter out the selected weather station and climate variable, and obtain the earliest start date available.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# User Input\ntarget_station <- \"Paya Lebar\"\ntarget_variable <- \"mean_temp\"\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Filter out target data from monthly_climate\ntarget <- filled_monthly_climate[\n  filled_monthly_climate$Station == target_station, \n  c(\"Station\", \"Year\", \"Month\", \"date\", target_variable)\n]\n\n# Convert NAs back to zero for sorting and cumsum\ntarget[is.na(target)] <- 0\ntarget <- target[order(target$date), ]\n\n# Finding earliest start date using cumulative sum\ntarget$cumulative_sum <- cumsum(target[target_variable])\n\ntarget <- target[target$cumulative_sum > 0, ]\n\ny <- dplyr::first(target[order(target$date), \"Year\"])[[1]] %>% \n  as.character() %>% \n  as.numeric()\nm <- dplyr::first(target[order(target$date), \"Month\"])[[1]] %>% \n  as.character() %>% \n  as.numeric()\n\nprint(paste0(\"Earliest start date: \", as.character(y), \"-\", as.character(m)))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"Earliest start date: 2017-9\"\n```\n:::\n:::\n\n\nPhase 2\n\n1.  User selects the start and end date using a slider (slider start date defined in step 2, end date is always Dec 2023), as well as training to test set ratio.\n\n2.  The code will slice the data according to the defined dates.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# User Input\ntarget_date_start <- \"2018-3\"\ntarget_date_end <- \"2023-12\"\ntrain_test_split <- 0.8\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Filter out defined time period\ntarget <- target[target$date >= target_date_start, ]\ntarget <- target[target$date <= target_date_end, ]\n\n# Find row number when training ends and validation starts\nsplit_train_end <- round(train_test_split*nrow(target)) - 1\nsplit_val_start <- round(train_test_split*nrow(target))\n\n# Check if there is no test, ie: train_test_split == 1 \n# if (target_date_end == target$date[split_val_start])\nif (train_test_split == 1) {\n  validation = FALSE\n} else {\n  validation = TRUE\n}\n\n# Create time series object\ntrain_ts <- ts(target[target_variable], \n               frequency = 12,\n               start = c(\n                 strsplit(target_date_start, \"-\")[[1]][1],\n                 strsplit(target_date_end, \"-\")[[1]][2]\n               ),\n               end = c(\n                 as.numeric(year(target$date[split_train_end])),\n                 as.numeric(month(target$date[split_train_end]))\n               ))\n```\n:::\n\n\n## 5.2 Model Fitting\n\nIn this section, we will use the inputs provided by the user to define the data that we will be using to fit the Holt Winters model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nHW <- HoltWinters(train_ts)\n\nresult_df <- target[,c(\"date\",target_variable)]\n\n\nif (validation) {\n  \n  val_period <- nrow(target) - split_val_start\n  \n  validation_preds <- predict(HW,\n                              n.ahead = val_period)\n  \n  result_df$fit <- NA\n  result_df$fit[13:(nrow(result_df)-val_period)] <- as.data.frame(HW$fitted)$xhat\n  \n  result_df$val <- NA\n  result_df$val[(nrow(result_df)-val_period+1):nrow(result_df)] <- validation_preds\n\n} else {\n  \n  result_df$fit <- NA\n  result_df$fit[13:nrow(result_df)] <- as.data.frame(HW$fitted)$xhat\n  \n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ng <- ggplot(data = result_df) + \n  geom_line(aes(x=date, y=.data[[target_variable]]), linewidth=1) +\n  geom_line(aes(x=date, y=fit), color=\"darkturquoise\", linewidth=1)\n\nif (validation) {\n  g <- g + geom_line(aes(x=date, y=val), color=\"coral\", linewidth=1)\n}\n\ng <- g + \n  ggtitle(\"Actual vs Predicted\") +\n  xlab(\"Date\") +\n  ylab(str_to_title(gsub(\"_\", \" \", target_variable)))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# data.frame(result_df[1], stack(result_df[2:ncol(result_df)]))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncomponents_dfts <- decompose(train_ts)\nplot(components_dfts)\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex04_files/figure-html/unnamed-chunk-27-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncomponents_dfts$seasonal %>% data.frame()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n             .\n1   0.35069739\n2   0.51637874\n3   0.78184546\n4   0.10795081\n5   0.15214565\n6   0.39058651\n7  -0.04180193\n8   0.15336817\n9  -0.38469650\n10 -0.76866902\n11 -0.91787452\n12 -0.33993077\n13  0.35069739\n14  0.51637874\n15  0.78184546\n16  0.10795081\n17  0.15214565\n18  0.39058651\n19 -0.04180193\n20  0.15336817\n21 -0.38469650\n22 -0.76866902\n23 -0.91787452\n24 -0.33993077\n25  0.35069739\n26  0.51637874\n27  0.78184546\n28  0.10795081\n29  0.15214565\n30  0.39058651\n31 -0.04180193\n32  0.15336817\n33 -0.38469650\n34 -0.76866902\n35 -0.91787452\n36 -0.33993077\n37  0.35069739\n38  0.51637874\n39  0.78184546\n40  0.10795081\n41  0.15214565\n42  0.39058651\n43 -0.04180193\n44  0.15336817\n45 -0.38469650\n46 -0.76866902\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmape <- MAPE(validation_preds, validation) * 100\n\nprint(mape)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 2770.858\n```\n:::\n:::\n\n\n## 5.2 Model Tuning\n\nAfter fitting the model, users are allowed to view validation results and decide if they wish to further tune the model by adjusting certain variables.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nalpha = 0\nbeta = 0\ngamma = 0\n```\n:::\n\n\n## 5.3 Model Forecast\n\nLastly, once parameters are confirmed, we can proceed to make predictions and plot them.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# https://www.r-bloggers.com/2012/07/holt-winters-forecast-using-ggplot2/\n\nHWplot <- function(ts_object, \n                   n.ahead = 4, \n                   CI = .95, \n                   error.ribbon = 'green', \n                   line.size = 1) {\n    \n    hw_object <- HoltWinters(ts_object)\n    \n    forecast <- predict(hw_object,  \n                        n.ahead = n.ahead,  \n                        prediction.interval = T,  \n                        level = CI)\n    \n    df <- as.data.frame(forecast)\n    \n    for_values <- data.frame(time = round(time(forecast), 3),  \n                             value_forecast = df$fit,  \n                             dev = df$upr - df$fit)\n    \n    fitted_values <- data.frame(time = round(time(hw_object$fitted), 3),\n                                fitted = as.data.frame(hw_object$fitted)$xhat)\n    \n    actual_values <- data.frame(time = round(time(hw_object$x), 3),\n                                Actual = c(hw_object$x))\n    \n    \n    graphset <- merge(actual_values,  fitted_values,  by='time',  all=TRUE)\n    graphset <- merge(graphset,  for_values,  all=TRUE,  by='time')\n    graphset[is.na(graphset$dev),  ]$dev <- 0\n    \n    graphset$Fitted <- c(rep(NA,  NROW(graphset) - (NROW(for_values) + NROW(fitted_values))),  fitted_values$fitted,  for_values$value_forecast)\n    \n    graphset.melt <- melt(graphset[, c('time', 'Actual', 'Fitted')], id='time')\n    \n    p <- ggplot(graphset.melt,  \n                aes(x=time,  y=value)) + \n      geom_ribbon(data=graphset, \n                  aes(x=time, \n                      y=Fitted, \n                      ymin=Fitted-dev,  \n                      ymax=Fitted + dev),  \n                  alpha=.2,  \n                  fill=error.ribbon) + \n      geom_line(aes(colour=variable), \n                linewidth=line.size) + \n      geom_vline(xintercept=max(actual_values$time),  \n                 lty=2) + \n      xlab('Time') + \n      ylab('Value') + \n      theme(legend.position='bottom') + \n      scale_colour_hue('')\n    \n    return(p)\n\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nHWplot(train_ts, n.ahead=36, CI=.95, error.ribbon='green',line.size=1)\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex04_files/figure-html/unnamed-chunk-32-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n:::\n\n\n# 6. Storyboard UI\n\nThis section describes the UI design and the intended work flow for users.\n\n## 6.1 User input\n\nThe user starts by selecting the weather station and climate variable of interest. These are selected from a pre-defined drop down list.\n\n## 6.2 Time frame and validation\n\nAfter the step in 6.1, the user will be prompted to select the time period as well as train test split.\n\nThe time period is selected using a slider. The start and end date of the slider is specific to the weather station and climate variable chosen earlier.\n\nThe train test split is a floating number between 0.5 and 1.\n\n## 6.3 Model Fit\n\nNext, the user will click the \"Fit Model\" button. This will trigger a couple of events.\n\nFirstly, this fits a Holts Winter model over the filtered data set based on the selected variables in 6.1 and 6.2. In addition, predictions will be made for the validation period with the fitted model.\n\nSecondly, left panel 3 and 4 will be revealed to the user. I will elaborate on these 2 panels in the following sections.\n\nThe main screen's first tab will now display a Actual vs Predicted plot. Predicted lines for training period and validation period will be in different colours.\n\nThe second tab will show a plot of the decomposed elements of the model, namely:\n\n-   Observed\n\n-   Trend\n\n-   Season\n\n-   Random\n\nAt the bottom of the screen, the training and validation MAPE and MAE will be shown in 4 separate boxes.\n\n## 6.4 Model Tuning\n\nLeft panel 3 shows the default parameters used in the Holts Winter model. Users will be allowed to change these parameters within their respective allowable limits and re-fit the model using the \"Fit Model\" button to observe the new changes.\n\n## 6.5 Model forecast\n\nLeft panel 4 is used for forecasting. Once users are satisfied with the tuned parameters, they can input the number of periods to be forecasted and click the \"Forecast\" button to generate the forecast results.\n\nThis will populate the Right screen tab 1 with the forecast plot.\n\nRight screen tab 2 contains a cycle plot which shows the results from a month by month view.\n",
    "supporting": [
      "Take-home_Ex04_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}