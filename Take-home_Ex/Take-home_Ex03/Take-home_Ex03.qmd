---
title: "Take-home_Ex03"
date: "February 13, 2024"
date-modified: "last-modified"
execute: 
  eval: true
  echo: true
  warning: false
editor: visual
---

# 1. Overview

According to an office report as shown in the infographic below,

-   Daily mean temperature are projected to increase by 1.4 to 4.6, and
-   The contrast between the wet months (November to January) and dry month (February and June to September) is likely to be more pronounced.

As a visual analytics greenhorn, you are keen to apply newly acquired visual interactivity and visualising uncertainty methods to validate the claims presented above.

# 2. Data Preparation

First, let us prepare the required data.

## 2.1 Loading R packages

We begin by loading the required R packages.

```{r}
#| code-fold: true
#| code-summary: "Show the code"

pacman::p_load(tidyverse,
               haven,
               dplyr,
               plotly,
               ggrepel, 
               patchwork, 
               ggthemes, 
               hrbrthemes,
               data.table,
               ggiraph)
```

## 2.2 Importing historical daily temperature data set

The data we will be using is the historical daily temperature data from Meteorological Service Singapore website. We will be looking at the daily records of July in the years 1983, 1993, 2003, 2013, and 2023 at the Changi Weather Station.

```{r}
#| code-fold: true
#| code-summary: "Show the code"

files = list.files(
  path = "data/",
  pattern = ".*csv$",
  ignore.case = F,
  full.names = T
)

data = lapply(files, data.table::fread, encoding = "Latin-1")
data = dplyr::bind_rows(data)
data <- as.data.frame(data)
```

## Data Wrangling

```{r}

data$`Minimum Temperature (°C)` <- ifelse(data$Year == 2023, data$`Minimum Temperature (Â°C)`, data$`Minimum Temperature (°C)`)
data$`Maximum Temperature (°C)` <- ifelse(data$Year == 2023, data$`Maximum Temperature (Â°C)`, data$`Maximum Temperature (°C)`)
data$`Mean Temperature (°C)` <- ifelse(data$Year == 2023, data$`Mean Temperature (Â°C)`, data$`Mean Temperature (°C)`)

month_data <- data %>% 
  group_by(Year) %>% 
  summarise(
    mean_month_temp = mean(`Mean Temperature (°C)`),
    se_month_temp = sd(`Mean Temperature (°C)`)/sqrt(n())
    )
```

```{r}
day_data <-
  data[c(
    "Station",
    "Year",
    "Month",
    "Day",
    "Mean Temperature (°C)",
    "Maximum Temperature (°C)",
    "Minimum Temperature (°C)"
  )]

colnames(day_data) <-
  c(
    "Station",
    "Year",
    "Month",
    "Day",
    "mean_day_temp",
    "max_day_temp",
    "min_day_temp"
  )
```

```{r}
model = lm(mean_day_temp ~ Year, day_data)
forecast = data.frame(Year = c(2033,
                               2043,
                               2053,
                               2063,
                               2073,
                               2083,
                               2093))
forecast = cbind(forecast, predict(model, forecast, interval = "confidence"))
```

# Visualization

## min and max

```{r}
palette_choice = 1

p1 <- ggplot(data=day_data, 
             aes(x = Day,
                 y = mean_day_temp,
                 color = as.factor(Year))) +
  geom_line_interactive(              
    aes(tooltip = Year, 
        data_id = Year),
    show.legend = F) +
  ylab("Temperature (°C)") +
  xlab("Day") +
  scale_color_brewer(name = "Year", palette = palette_choice)

p2 <- ggplot(
  data=day_data, 
  aes(x = as.factor(Year),
      y = mean_day_temp,
      fill = as.factor(Year))
  ) +
  geom_boxplot_interactive(
    aes(tooltip = Year, 
        data_id = Year),
    linewidth = 0.1,
    show.legend = F
  ) +
  ylab("Temperature (°C)") +
  xlab(element_blank()) + 
  theme(
    axis.text.x = element_blank(), 
    axis.ticks.x = element_blank()) +
  scale_fill_brewer(name = "Year", palette = palette_choice)

p3 <- ggplot() +
  geom_point_interactive(
    data = month_data,
    aes(x = Year,
        y = mean_month_temp,
        tooltip = Year, 
        data_id = Year,
        color = as.factor(Year))
  ) + 
  geom_pointrange_interactive(
    data = forecast,
    aes(x = Year,
        y = fit,
        ymin = lwr,
        ymax = upr,
        tooltip = paste(Year, 
                        " Forecast:\n", 
                        round(fit,2), 
                        " +/- ", 
                        round(fit-lwr,2)),
        data_id = Year),
    color = "limegreen",
    fatten = 0.5
  ) +
  ylab("Temperature (°C)") +
  scale_x_continuous(
    breaks = c(1983,1993,2003,2013,2023,2093),
    limits = c(1983,2093)
  ) +
  scale_color_brewer(name = "Year", palette = palette_choice)

girafe(                                  
  code = print((
    (p1 + p2 +
      plot_layout(
        guides = "collect",
        axes = "collect",
        widths = c(4,1)
      )) / p3 + 
      plot_layout(
        guides = "collect",
        axes = "collect",
        heights = c(1,1)
      ) +
      plot_annotation(title = "Daily temperature in December"))),                   
  width_svg = 6,                         
  height_svg = 6*0.618,
  options = list(
    opts_hover(css = "stroke-width:2;"),
    opts_hover_inv(css = "opacity:0.2;") 
  )                                        
)                                        
```

```{r}
p3 <- ggplot() +
  geom_point_interactive(
    data = month_data,
    aes(x = Year,
        y = mean_month_temp,
        tooltip = Year, 
        data_id = Year,
        color = as.factor(Year))
  ) + 
  geom_pointrange_interactive(
    data = forecast,
    aes(x = Year,
        y = fit,
        ymin = lwr,
        ymax = upr,
        tooltip = "Forcast",
        data_id = Year)
  ) +
  ylab("Temperature (°C)") +
  scale_x_continuous(
    breaks = c(1983,1993,2003,2013,2023,2100),
    limits = c(1983,2100)
  ) +
  scale_color_discrete(name = "Year")

p3
```
